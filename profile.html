<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Profile - BulkBuy</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded shadow-md w-full max-w-md">
        <div class="flex flex-col items-center mb-4">
            <!-- Profile image (click to refresh profile page) -->
            <img id="profileImg" src="https://ui-avatars.com/api/?name=User" alt="Profile" class="h-20 w-20 rounded-full border-2 border-indigo-500 cursor-pointer mb-2">
            <div id="userRole" class="text-sm text-gray-500"></div>
        </div>
        <h2 class="text-2xl font-bold mb-6 text-center">Edit Profile</h2>
        <form id="profileForm" class="space-y-4">
            <div>
                <label class="block text-gray-700">Name</label>
                <input type="text" id="name" required class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-gray-700">Email</label>
                <input type="email" id="email" disabled class="w-full px-3 py-2 border rounded bg-gray-100">
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Save</button>
            <p id="profileError" class="text-red-500 text-sm mt-2"></p>
            <p id="profileSuccess" class="text-green-500 text-sm mt-2"></p>
        </form>
    </div>
    <script>
    // Fetch user profile
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = 'login.html';
        try {
            const res = await fetch('http://localhost:5000/api/profile', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) throw new Error('Not logged in');
            const user = await res.json();
            document.getElementById('name').value = user.name;
            document.getElementById('email').value = user.email;
            document.getElementById('userRole').textContent = user.role ? `Role: ${user.role}` : '';
            // Set profile image using initials
            document.getElementById('profileImg').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'User')}`;
        } catch {
            window.location.href = 'login.html';
        }
    });

    // Refresh profile page when profile image is clicked
    document.getElementById('profileImg').addEventListener('click', function() {
        window.location.reload();
    });

    // Update profile
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const name = document.getElementById('name').value;
        const errorElem = document.getElementById('profileError');
        const successElem = document.getElementById('profileSuccess');
        errorElem.textContent = '';
        successElem.textContent = '';
        const token = localStorage.getItem('token');
        try {
            const res = await fetch('http://localhost:5000/api/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ name })
            });
            const data = await res.json();
            if (!res.ok) {
                errorElem.textContent = data.error || 'Update failed';
                return;
            }
            successElem.textContent = 'Profile updated!';
            // Update avatar with new name
            document.getElementById('profileImg').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}`;
        } catch {
            errorElem.textContent = 'Network error';
        }
    });
    </script>
</body>